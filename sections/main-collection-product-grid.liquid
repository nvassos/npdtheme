{{ 'section-main-collection.css' | asset_url | stylesheet_tag }}
<script src="{{ 'collection-filters.js' | asset_url }}" defer></script>

{% comment %}
  Tag-based Collection Filtering with Infinite Scroll
{% endcomment %}

<div class="collection-page-wrapper">
  <div class="collection-page-container">
    
    {%- comment -%} SIDEBAR WITH TAG FILTERS {%- endcomment -%}
    <div class="collection-sidebar">
      <div class="filter-section">
        <h2 class="filter-title">Filter</h2>
        
        {%- comment -%} Active Filter Tags {%- endcomment -%}
        <div class="filter-tags" id="active-filters">
          <!-- Active tags will be populated by JavaScript -->
        </div>
        
        <button class="clear-all-btn" id="clear-all-filters" style="display: none;">Clear All</button>
      </div>

      <form id="TagFiltersForm" class="tag-filters-form">
        
        {%- comment -%} AVAILABILITY FILTER {%- endcomment -%}
        <div class="filter-group">
          <div class="filter-group-title">Availability</div>
          <div class="filter-options">
            <div class="filter-option">
              <input type="checkbox" id="filter-quick-ship" name="tags" value="Quick Ship" data-filter-group="availability">
              <label for="filter-quick-ship">
                Quick Ship
                <span class="filter-count">in stock and ready to ship</span>
              </label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="filter-made-to-order" name="tags" value="Made to Order" data-filter-group="availability">
              <label for="filter-made-to-order">
                Made to Order
                <span class="filter-count">7-10 days production</span>
              </label>
            </div>
          </div>
        </div>

        {%- comment -%} CATEGORY FILTER {%- endcomment -%}
        <div class="filter-group">
          <button type="button" class="filter-group-title collapsible" aria-expanded="true">Category</button>
          <div class="filter-options">
            {% assign categories = "Kitchen,Bath,Repair Parts,Acrylics" | split: "," %}
            {% for category in categories %}
              <div class="filter-option">
                <input type="checkbox" id="filter-category-{{ category | handle }}" name="tags" value="{{ category }}" data-filter-group="category">
                <label for="filter-category-{{ category | handle }}">{{ category }}</label>
              </div>
            {% endfor %}
          </div>
        </div>

        {%- comment -%} PLANOGRAM FILTER {%- endcomment -%}
        <div class="filter-group">
          <button type="button" class="filter-group-title collapsible" aria-expanded="true">Planogram</button>
          <div class="filter-options">
            <div class="filter-group-subtitle">DELTA</div>
            {% assign delta_planograms = "12ft Bath,4ft Universal Shower,4ft Kitchen,6ft Bath,8ft Bath" | split: "," %}
            {% for planogram in delta_planograms %}
              <div class="filter-option">
                <input type="checkbox" id="filter-planogram-{{ planogram | handle }}" name="tags" value="{{ planogram }}" data-filter-group="planogram">
                <label for="filter-planogram-{{ planogram | handle }}">{{ planogram }}</label>
              </div>
            {% endfor %}
            
            <div class="filter-group-subtitle">BRIZO</div>
            {% assign brizo_planograms = "Brizo 12ft,Brizo 8ft,Brizo 6ft" | split: "," %}
            {% for planogram in brizo_planograms %}
              <div class="filter-option">
                <input type="checkbox" id="filter-planogram-{{ planogram | handle }}" name="tags" value="{{ planogram }}" data-filter-group="planogram">
                <label for="filter-planogram-{{ planogram | handle }}">{{ planogram }}</label>
              </div>
            {% endfor %}
          </div>
        </div>

        {%- comment -%} BRAND FILTER {%- endcomment -%}
        <div class="filter-group filter-group--collapsed">
          <button type="button" class="filter-group-title collapsible collapsed" aria-expanded="false">Brand</button>
          <div class="filter-options collapsed">
            {% assign brands = "Delta,Brizo,Peerless" | split: "," %}
            {% for brand in brands %}
              <div class="filter-option">
                <input type="checkbox" id="filter-brand-{{ brand | handle }}" name="tags" value="{{ brand }}" data-filter-group="brand">
                <label for="filter-brand-{{ brand | handle }}">{{ brand }}</label>
              </div>
            {% endfor %}
          </div>
        </div>

        {%- comment -%} PRODUCT TYPE FILTER {%- endcomment -%}
        <div class="filter-group filter-group--collapsed">
          <button type="button" class="filter-group-title collapsible collapsed" aria-expanded="false">Product Type</button>
          <div class="filter-options collapsed">
            {% assign product_types = "Faucets,Showers,Accessories,Toilets,Tubs,Displays" | split: "," %}
            {% for type in product_types %}
              <div class="filter-option">
                <input type="checkbox" id="filter-type-{{ type | handle }}" name="tags" value="{{ type }}" data-filter-group="product-type">
                <label for="filter-type-{{ type | handle }}">{{ type }}</label>
              </div>
            {% endfor %}
          </div>
        </div>

        {%- comment -%} SUB-TYPE FILTER {%- endcomment -%}
        <div class="filter-group filter-group--collapsed">
          <button type="button" class="filter-group-title collapsible collapsed" aria-expanded="false">Sub-Type</button>
          <div class="filter-options collapsed">
            {% assign sub_types = "Pull-Down,Pull-Out,Single Handle,Two Handle,Wall Mount,Deck Mount" | split: "," %}
            {% for sub_type in sub_types %}
              <div class="filter-option">
                <input type="checkbox" id="filter-subtype-{{ sub_type | handle }}" name="tags" value="{{ sub_type }}" data-filter-group="sub-type">
                <label for="filter-subtype-{{ sub_type | handle }}">{{ sub_type }}</label>
              </div>
            {% endfor %}
          </div>
        </div>

        {%- comment -%} COLLECTION FILTER {%- endcomment -%}
        <div class="filter-group filter-group--collapsed">
          <button type="button" class="filter-group-title collapsible collapsed" aria-expanded="false">Collection</button>
          <div class="filter-options collapsed">
            {% assign collections = "Trinsic,Ara,Cassidy,Essa,Linden,Ashlyn,Lahara" | split: "," %}
            {% for coll in collections %}
              <div class="filter-option">
                <input type="checkbox" id="filter-collection-{{ coll | handle }}" name="tags" value="{{ coll }}" data-filter-group="collection">
                <label for="filter-collection-{{ coll | handle }}">{{ coll }}</label>
              </div>
            {% endfor %}
          </div>
        </div>

      </form>
    </div>

    {%- comment -%} MAIN CONTENT {%- endcomment -%}
    <div class="main-content">
      
      {%- comment -%} SEARCH & SORT SECTION {%- endcomment -%}
      <div class="collection-header-controls">
        {%- comment -%} Search Bar {%- endcomment -%}
        <div class="collection-search-wrapper">
          <div class="search-input-container">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16zM19 19l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <input 
              type="text" 
              id="collection-search" 
              class="collection-search-input" 
              placeholder="Search products, SKU, Deposco ID..."
              autocomplete="off"
            >
            <button type="button" class="search-clear-btn" id="search-clear" style="display: none;">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M12 4L4 12M4 4l8 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
          
          {%- comment -%} Autocomplete Results {%- endcomment -%}
          <div class="search-autocomplete-results" id="search-results" style="display: none;">
            <div class="search-results-header">
              <span class="search-results-count"></span>
            </div>
            <div class="search-results-list"></div>
          </div>
        </div>

        {%- comment -%} Sort Dropdown {%- endcomment -%}
        <div class="sort-section">
          <span class="sort-label">Sort:</span>
          <select class="sort-select" id="collection-sort">
            <option value="manual">Featured</option>
            <option value="best-selling">Best Selling</option>
            <option value="title-ascending">A-Z</option>
            <option value="title-descending">Z-A</option>
            <option value="price-ascending">Price: Low</option>
            <option value="price-descending">Price: High</option>
            <option value="created-descending">Newest</option>
            <option value="created-ascending">Oldest</option>
          </select>
        </div>
      </div>

      {%- comment -%} Hidden Product Data for Search (includes metafields) {%- endcomment -%}
      <script type="application/json" id="collection-products-data">
        [
          {% for product in collection.products %}
            {
              "id": {{ product.id | json }},
              "title": {{ product.title | json }},
              "handle": {{ product.handle | json }},
              "vendor": {{ product.vendor | json }},
              "tags": {{ product.tags | json }},
              "image": {% if product.featured_image %}{{ product.featured_image | image_url: width: 200 | json }}{% else %}""{% endif %},
              "variants": [
                {% for variant in product.variants %}
                  {
                    "id": {{ variant.id | json }},
                    "title": {{ variant.title | json }},
                    "sku": {{ variant.sku | json }},
                    "deposco_id": {{ variant.metafields.custom.deposco_id | json }}
                  }{% unless forloop.last %},{% endunless %}
                {% endfor %}
              ]
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ]
      </script>

      {%- comment -%} PRODUCT GRID {%- endcomment -%}
      <div id="product-grid" class="collection-product-grid" data-collection-handle="{{ collection.handle }}">
        {% paginate collection.products by 24 %}
          <div class="product-grid-wrapper">
            {% for product in collection.products %}
              {% render 'product-card-collection', product: product %}
            {% endfor %}
          </div>

          {%- comment -%} Infinite Scroll Loading Indicator {%- endcomment -%}
          {% if paginate.next %}
            <div class="infinite-scroll-loading" data-next-url="{{ paginate.next.url }}">
              <div class="loading-spinner">Loading more products...</div>
            </div>
          {% endif %}
        {% endpaginate %}
      </div>

      {%- comment -%} Empty State {%- endcomment -%}
      <div id="no-results" class="no-results" style="display: none;">
        <p>No products found matching your filters.</p>
        <button class="clear-all-btn" onclick="document.getElementById('clear-all-filters').click()">Clear All Filters</button>
      </div>
    </div>

  </div>
</div>

{% schema %}
{
  "name": "Collection Product Grid",
  "settings": [
    {
      "type": "range",
      "id": "products_per_page",
      "min": 8,
      "max": 48,
      "step": 4,
      "default": 24,
      "label": "Products per page"
    }
  ]
}
{% endschema %}
